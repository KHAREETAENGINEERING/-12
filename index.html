<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>Ø¹Ù‚Ø§Ø± - Ø¹Ù…Ù‘Ø§Ù† | Ù†Ø³Ø®Ø© Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>

<!-- Tailwind -->
 <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

<script src="https://cdn.tailwindcss.com"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper/swiper-bundle.min.js"></script>



<style>
  html, body {height: 100%; margin: 0;}
  #map {position: fixed; inset: 0;}

  /* ========= Ù…Ø§Ø±ÙƒØ± Ø§Ù„Ø³Ø¹Ø± (Ø£ØµØºØ± ÙˆØ£ÙˆØ¶Ø­) ========= */
  .leaflet-div-icon { background: transparent; border: none; }
  .price-pin { position: relative; display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; color:#0b1020; font-weight:800; font-size:12px; background:#fff; border:1px solid rgba(2,6,23,.08); box-shadow:0 6px 22px rgba(2,6,23,.14); }
  .price-pin .dot { width:8px; height:8px; border-radius:999px; }
  .price-pin.sale .dot { background:#0ea5e9; }
  .price-pin.rent .dot { background:#10b981; }
  .price-pin .val { direction:ltr; }
  .price-pin:after{ content:""; position:absolute; left:50%; bottom:-7px; transform:translateX(-50%); width:10px; height:10px; background:#fff; border-left:1px solid rgba(2,6,23,.08); border-bottom:1px solid rgba(2,6,23,.08); transform: translateX(-50%) rotate(45deg); }

  /* ========= Ø¹Ù†Ù‚ÙˆØ¯ ========= */
  .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background: transparent; }
  .marker-cluster div { background:#111827; color:#fff; border-radius:999px; padding:6px 10px; font-weight:800; box-shadow:0 4px 14px rgba(0,0,0,.18); border:2px solid rgba(255,255,255,.85); font-size:12px; }

  /* ========= Popup Ø£Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª ========= */
  .leaflet-pane.leaflet-popup-pane { z-index: 900 !important; }
  .leaflet-popup-content-wrapper { border-radius:16px; box-shadow:0 20px 70px rgba(2,6,23,.18); border:1px solid rgba(2,6,23,.06); }
  .leaflet-popup-tip { display:none; }
/* =================== Ø§Ù„Ø¨ÙˆØ¨ Ø§Ø¨ =================== */
.leaflet-popup {
  z-index: 9999 !important; /* ÙÙˆÙ‚ ÙƒÙ„ Ø´ÙŠØ¡ */
}
.leaflet-popup-content-wrapper {
  width: 280px;  /* Ø­Ø¬Ù… Ø«Ø§Ø¨Øª Ù„Ù„Ø¨ÙˆØ¨ Ø§Ø¨ */
  max-width: 90vw;
  padding: 8px;
  border-radius: 10px;
  z-index: 9999 !important;
}
.leaflet-popup-content {
  margin: 0;
  padding: 0;
  font-size: 13px; /* Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
}

/* =================== Ø§Ù„ØµÙˆØ± ÙƒØ³Ù„Ø§ÙŠØ¯Ø± =================== */
.popup-images {
  display: flex;
  overflow-x: auto;
  gap: 5px;
  scroll-snap-type: x mandatory;
}
.popup-images img {
  flex: 0 0 auto;
  width: 100%;
  max-width: 260px;
  height: 150px;
  object-fit: cover;
  border-radius: 8px;
  scroll-snap-align: start;
}

/* Ø¥Ø²Ø§Ù„Ø© scrollbar Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆØ§ØªÙ */
.popup-images::-webkit-scrollbar {
  display: none;
}

/* =================== Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‡Ø§ØªÙ =================== */
@media (max-width: 420px) {
  .leaflet-popup-content-wrapper {
    width: 220px;
    max-width: 85vw;
    padding: 6px;
  }
  .leaflet-popup-content {
    font-size: 11px;
  }
  .popup-images img {
    height: 100px;
  }
  .popup-images {
    gap: 3px;
  }
  /* ØªØµØºÙŠØ± Ø§Ù„Ø£Ø²Ø±Ø§Ø±/icons */
  .popup-content a, .popup-content button {
    font-size: 11px;
    padding: 4px 6px;
  }
}

/* =================== Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© =================== */
.floating-top {
  position: fixed;
  left: 10px;
  right: 10px;
  top: 10px;
  z-index: 1000;  /* Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø¨ÙˆØ¨ Ø§Ø¨ */
}
.glass { backdrop-filter: blur(8px); background: rgba(255,255,255,.86); box-shadow: 0 8px 30px rgba(2,6,23,.08); }
.pill { border-radius: 999px; padding: 6px 10px; border:1px solid #e5e7eb; background:#fff; font-size:12px; }
.pill.active { border-color:#0ea5e9; color:#0ea5e9; font-weight:800; }
.ctrl { box-shadow: 0 6px 20px rgba(2,6,23,.10); }

  /* ========= Ø´ÙŠØª Ø³ÙÙ„ÙŠ ========= */
  .sheet { position: fixed; left:0; right:0; bottom:0; background:#3cffae; border-radius:20px 20px 0 0; box-shadow: 0 -10px 40px rgba(2,6,23,.15); transition: transform .25s ease; will-change: transform; }
  .sheet.collapsed { transform: translateY(calc(100% - 92px)); }
  .sheet.mid { transform: translateY(42%); }
  .sheet.expanded { transform: translateY(0%); }
  .grabber { width:44px; height:5px; background:#77797e; border-radius:999px; margin:6px auto 10px; }
  .safe-top { padding-top: env(safe-area-inset-top); }
  .safe-bottom { padding-bottom: calc(12px + env(safe-area-inset-bottom)); }

  /* ========= Ø¹Ù†Ø§ØµØ± Ø¹Ù„ÙˆÙŠØ© ========= */
  .floating-top { position: fixed; left:10px; right:10px; top:10px; z-index: 800; }
  .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,.86); box-shadow: 0 8px 30px rgba(2,6,23,.08); }
  .pill { border-radius: 999px; padding: 6px 10px; border:1px solid #e5e7eb; background:#fff; font-size:12px; }
  .pill.active { border-color:#0ea5e9; color:#0ea5e9; font-weight:800; }
  .ctrl { box-shadow: 0 6px 20px rgba(2,6,23,.10); }

  /* ========= Ø²Ø± Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠØ·ÙÙˆ Ø£Ø³ÙÙ„ Ø§Ù„ÙŠÙ…ÙŠÙ† ========= */
  .fab { position:fixed; right:14px; bottom:90px; z-index:820; }
  
</style>
</head>
<body class="bg-slate-50">

<!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="map" role="application" aria-label="Ø®Ø±ÙŠØ·Ø© Ø¹Ù‚Ø§Ø±Ø§Øª Ø¹Ù…Ù‘Ø§Ù†"></div>

<!-- Ø¹Ù†Ø§ØµØ± Ø¹Ù„ÙˆÙŠØ© (Ø¨Ø­Ø« + ÙÙ„Ø§ØªØ± + ØªØ¨Ø¯ÙŠÙ„ Ø·Ø¨Ù‚Ø©) -->
<div class="floating-top safe-top">
  <div class="glass rounded-2xl px-3 py-2 ctrl">
    <div class="flex items-center gap-2">
      <button id="btnBackToCity" class="pill text-xs">Ø¹Ù…Ù‘Ø§Ù†</button>
      <div class="flex-1 flex items-center gap-2">
        <input id="q" class="flex-1 bg-white rounded-xl px-3 py-2 text-sm border focus:outline-none" placeholder="Ø§Ø¨Ø­Ø«: Ø­ÙŠØŒ Ø¹Ù†ÙˆØ§Ù†ØŒ ÙƒÙ„Ù…Ø©â€¦" />
        <button id="btnSearch" class="pill">Ø¨Ø­Ø«</button>
      </div>
      <button id="btnBasemap" class="pill" title="ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©">ğŸ—ºï¸</button>
    </div>
    <div class="mt-2 flex items-center gap-2 overflow-x-auto">
      <button id="fType" class="pill">Ø§Ù„ÙƒÙ„</button>
      <button id="fSale" class="pill">Ù„Ù„Ø¨ÙŠØ¹</button>
      <button id="fRent" class="pill">Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</button>
      <button id="fArea" class="pill">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</button>
      <button id="fPrice" class="pill">Ø§Ù„Ø³Ø¹Ø±</button>
      <button id="fMore" class="pill">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
    </div>
  </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ø¦Ù… -->
<button id="btnAdmin" class="fab rounded-full px-4 py-3 bg-slate-900 text-white shadow-xl text-sm font-bold flex items-center gap-2">
  <span>Ø§Ù„Ù…Ø¯ÙŠØ±</span>
  
</button>

<!-- Ø´ÙŠØª Ø³ÙÙ„ÙŠ: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
<div id="sheet" class="sheet collapsed" style="z-index: 810;">
  <div class="safe-bottom px-4">
    <div class="grabber"></div>
    <div class="flex items-center justify-between">
      <div class="text-xs text-slate-500">Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¶Ù…Ù† Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø©: <span id="count" class="font-bold text-slate-900">0</span></div>
      <div class="flex items-center gap-2">
        <select id="sort" class="text-xs border rounded-lg px-2 py-1">
          <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
          <option value="low">Ø§Ù„Ø³Ø¹Ø± â†‘</option>
          <option value="high">Ø§Ù„Ø³Ø¹Ø± â†“</option>
        </select>
        <button id="btnRefresh" class="text-blue-600 text-xs">ØªØ­Ø¯ÙŠØ«</button>
      </div>
    </div>
    <div id="list" class="mt-3 space-y-3 pb-6"></div>
  </div>
</div>

<!-- Ø­ÙˆØ§Ø±Ø§Øª Ø¹Ø§Ù…Ø© (ÙÙ„ØªØ±Ø© + Ù…Ø¯ÙŠØ±) -->
<div id="modal" class="fixed inset-0 hidden items-end justify-center bg-black/40 z-[900]">
  <div class="bg-white w-full rounded-t-2xl p-4 max-h-[86vh] overflow-y-auto">
    <div id="modalContent"></div>
    <div class="mt-3 flex gap-2">
      <button id="applyModal" class="flex-1 py-2 bg-blue-600 text-white rounded-xl">ØªØ·Ø¨ÙŠÙ‚</button>
      <button id="closeModal" class="flex-1 py-2 border rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
  
/********************** Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© **********************/
const AMMAN = [31.9539, 35.9106];
const map = L.map('map', { zoomControl: false, minZoom: 11, maxZoom: 19 }).setView(AMMAN, 12);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: 'Â© OpenStreetMap' }).addTo(map);
const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution:'Â© Esri' });

L.control.zoom({ position: 'topleft' }).addTo(map);

const cluster = L.markerClusterGroup({ showCoverageOnHover: false, maxClusterRadius: 60 });
map.addLayer(cluster);

/********************** Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© **********************/
const AREAS = [
  '', 'Ø¹Ø¨Ø¯ÙˆÙ†','Ø§Ù„ØµÙˆÙŠÙÙŠØ©','Ø¯Ø§Ø¨ÙˆÙ‚','ØªÙ„Ø§Ø¹ Ø§Ù„Ø¹Ù„ÙŠ','Ø§Ù„Ø´Ù…ÙŠØ³Ø§Ù†ÙŠ','Ù…Ø§Ø±ÙƒØ§','Ø¬Ø¨Ù„ Ø¹Ù…Ù‘Ø§Ù†','Ø§Ù„Ù„ÙˆÙŠØ¨Ø¯Ø©','Ø§Ù„Ø¨ÙŠØ§Ø¯Ø±','Ø§Ù„Ø³Ø§Ø¨Ø¹','Ø§Ù„Ø«Ø§Ù…Ù†','Ø§Ù„Ø®Ø§Ù…Ø³','Ø®Ù„Ø¯Ø§','Ø£Ù… Ø£Ø°ÙŠÙ†Ø©','Ø£Ù… Ø§Ù„Ø³Ù…Ø§Ù‚','Ø§Ù„Ø±Ø§Ø¨ÙŠØ©','Ø¯ÙŠØ± ØºØ¨Ø§Ø±','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ©','ØµÙˆÙŠÙ„Ø­','Ø§Ù„Ø¬Ø¨ÙŠÙ‡Ø©','Ø£Ø¨Ùˆ Ù†ØµÙŠØ±','Ø´ÙØ§ Ø¨Ø¯Ø±Ø§Ù†','Ø·Ø¨Ø±Ø¨ÙˆØ±','Ù…Ø±Ø¬ Ø§Ù„Ø­Ù…Ø§Ù…','Ø§Ù„ÙŠØ§Ø¯ÙˆØ¯Ø©','Ø§Ù„Ù‚ÙˆÙŠØ³Ù…Ø©','Ø¬Ø§ÙˆØ§','Ù†Ø§Ø¹ÙˆØ±','Ø§Ù„ÙØ­ÙŠØµ','Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡','Ù…Ø£Ø¯Ø¨Ø§'
];

const seed = [
  { id:1, title:'Ø´Ù‚Ø© ÙØ§Ø®Ø±Ø© Ù„Ù„Ø¨ÙŠØ¹ - Ø¹Ø¨Ø¯ÙˆÙ†', type:'apartment', tx:'sale', area:'Ø¹Ø¨Ø¯ÙˆÙ†', price:120000, rooms:3, bath:2, space:130, lat:31.965, lon:35.888, phone:'0797654321', createdAt: Date.now()-86400000*3 },
  { id:2, title:'Ø£Ø±Ø¶ Ø³ÙƒÙ†ÙŠØ© Ù„Ù„Ø¨ÙŠØ¹ - Ù…Ø§Ø±ÙƒØ§', type:'land', tx:'sale', area:'Ù…Ø§Ø±ÙƒØ§', price:80000, lat:31.950, lon:35.930, phone:'0791112233', createdAt: Date.now()-86400000*6 },
  { id:3, title:'ÙÙŠÙ„Ø§ Ø±Ø§Ù‚ÙŠØ© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± - Ø§Ù„Ø´Ù…ÙŠØ³Ø§Ù†ÙŠ', type:'villa', tx:'rent', area:'Ø§Ù„Ø´Ù…ÙŠØ³Ø§Ù†ÙŠ', price:1800, rooms:5, bath:3, space:300, lat:31.957, lon:35.902, phone:'0790007766', createdAt: Date.now()-86400000*1 },
  { id:4, title:'Ø´Ù‚Ø© Ù„Ù„Ø¨ÙŠØ¹ - Ø®Ù„Ø¯Ø§', type:'apartment', tx:'sale', area:'Ø®Ù„Ø¯Ø§', price:155000, rooms:4, bath:3, space:165, lat:31.993, lon:35.854, phone:'0795553332', createdAt: Date.now()-86400000*2 },
  { id:5, title:'Ø´Ù‚Ø© Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± - ØªÙ„Ø§Ø¹ Ø§Ù„Ø¹Ù„ÙŠ', type:'apartment', tx:'rent', area:'ØªÙ„Ø§Ø¹ Ø§Ù„Ø¹Ù„ÙŠ', price:650, rooms:2, bath:2, space:95, lat:31.994, lon:35.877, phone:'0798881122', createdAt: Date.now()-86400000*10 },
  { id:6, title:'Ù…Ø­Ù„ ØªØ¬Ø§Ø±ÙŠ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø± - Ø§Ù„Ø³Ø§Ø¨Ø¹', type:'shop', tx:'rent', area:'Ø§Ù„Ø³Ø§Ø¨Ø¹', price:900, lat:31.969, lon:35.877, phone:'0797774441', createdAt: Date.now()-86400000*4 },
  { id:7, title:'Ø£Ø±Ø¶ Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø¹ÙŠÙ† - Ù†Ø§Ø¹ÙˆØ±', type:'land', tx:'sale', area:'Ù†Ø§Ø¹ÙˆØ±', price:130000, lat:31.86, lon:35.82, phone:'0792345678', createdAt: Date.now()-86400000*14 },
];

const STORAGE_KEY = 'aqaar_mobile_props_v2';
const SETTINGS_KEY = 'aqaar_settings_v1';

function loadLocal() { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) { localStorage.setItem(STORAGE_KEY, JSON.stringify(seed)); return seed.slice(); } try { return JSON.parse(raw); } catch { localStorage.setItem(STORAGE_KEY, JSON.stringify(seed)); return seed.slice(); } }
function saveLocal(list) { localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
let PROPS = loadLocal();

/********************** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) **********************/
const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
let API_BASE = settings.API_BASE || '';
let ADMIN_TOKEN = settings.ADMIN_TOKEN || '';
let SAVE_TARGET = 'server';

async function tryFetchServerList(){
  if(!API_BASE) return null;
  try{
    const res = await fetch(API_BASE + '/api/listings');
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    if(Array.isArray(data)) return data;
  }catch(e){ /* ØªØ¬Ø§Ù‡Ù„ */ }
  return null;
}

async function persistListing(listing){
  if(SAVE_TARGET === 'server' && API_BASE){
    try{
      const res = await fetch(API_BASE + '/api/listings', {
        method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-token': ADMIN_TOKEN || '' },
        body: JSON.stringify(listing)
      });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const saved = await res.json();
      return saved;
    }catch(err){ alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹.'); }
  }
  // Ù…Ø­Ù„ÙŠ
  const next = [...PROPS, listing];
  PROPS = next; saveLocal(next); return listing;
}

/********************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© **********************/
const E = sel => document.querySelector(sel);
const fmt = n => (typeof n === 'number') ? n.toLocaleString('en-US') : n;
const jd = v => typeof v === 'number' && !Number.isNaN(v);
const ago = t => { const s=(Date.now()-t)/1000; if(s<60) return 'Ø§Ù„Ø¢Ù†'; const m=s/60; if(m<60) return Math.floor(m)+' Ø¯'; const h=m/60; if(h<24) return Math.floor(h)+' Ø³'; const d=h/24; return Math.floor(d)+' ÙŠ'; };

function makePriceIcon(p){
  const html = `<div class="price-pin ${p.tx==='rent'?'rent':'sale'}"><span class="dot"></span><span class="val">${fmt(p.price)}</span><span class="unit">${p.tx==='rent'?'Ø¯/Ø´Ù‡Ø±':'Ø¯.Ø£'}</span></div>`;
  return L.divIcon({ html, className: 'price', iconSize: null });
}

function cardHTML(p){
  const typeMap = { apartment:'Ø´Ù‚Ø©', villa:'ÙÙŠÙ„Ø§', land:'Ø£Ø±Ø¶', shop:'Ù…Ø­Ù„' };
  const txMap = { sale:'Ù„Ù„Ø¨ÙŠØ¹', rent:'Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±' };
  const whats = `https://wa.me/962${(p.phone||'').replace(/^0/, '')}?text=${encodeURIComponent('Ù…Ø±Ø­Ø¨Ø§ØŒ Ù…Ù‡ØªÙ… Ø¨Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: '+p.title)}`;
  const gmaps = `https://www.google.com/maps?q=${p.lat},${p.lon}`;
  return `
  <div class="p-3 rounded-2xl border shadow-sm">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-xs text-slate-500">${typeMap[p.type]||''} â€¢ ${p.area}</div>
        <div class="font-bold leading-6 text-sm">${p.title}</div>
      </div>
      <div class="text-right">
        <div class="font-extrabold ${p.tx==='rent'?'text-emerald-600':'text-sky-600'} text-sm">${fmt(p.price)} ${p.tx==='rent'?'Ø¯/Ø´Ù‡Ø±':'Ø¯.Ø£'}</div>
        <div class="text-[11px] text-slate-500">${txMap[p.tx]} â€¢ ${p.createdAt?ago(p.createdAt):''}</div>
      </div>
    </div>
    <div class="mt-2 text-[12px] text-slate-600">
      ${p.space?`Ø§Ù„Ù…Ø³Ø§Ø­Ø©: <b>${fmt(p.space)}</b> Ù…Â² â€¢ `:''}
      ${p.rooms?`ØºØ±Ù: <b>${fmt(p.rooms)}</b> â€¢ `:''}
      ${p.bath?`Ø­Ù…Ø§Ù…Ø§Øª: <b>${fmt(p.bath)}</b>`:''}
    </div>
    <div class="mt-3 grid grid-cols-3 gap-2 text-[12px]">
      <button class="py-2 rounded-xl border" onclick="flyTo(${p.lat},${p.lon})">Ø¹Ø±Ø¶</button>
      <a class="py-2 rounded-xl border text-center" href="${gmaps}" target="_blank">Ø§ØªØ¬Ø§Ù‡Ø§Øª</a>
      <div class="grid grid-cols-2 gap-2 col-span-3">
        <a class="py-2 rounded-xl bg-sky-600 text-white text-center" href="tel:+962${p.phone}">Ø§ØªØµØ§Ù„</a>
        <a class="py-2 rounded-xl bg-emerald-600 text-white text-center" href="${whats}" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨</a>
      </div>
    </div>
  </div>`;
}

/********************** ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª + ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ± **********************/
async function loadAds() {
  try {
    const res = await fetch('http://localhost:3000/listings');
    const ads = await res.json();

    // ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØµÙˆØ± Ø¥Ù„Ù‰ Ø±ÙˆØ§Ø¨Ø· ÙƒØ§Ù…Ù„Ø©
    PROPS = ads.map(ad => {
      if(ad.images && ad.images.length){
        ad.images = ad.images.map(imgName => `http://localhost:3000/images/${ad.id}/${imgName}`);
      } else {
        ad.images = [];
      }
      return ad;
    });

    drawMarkers(PROPS);
  } catch(err) {
    console.error('Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª:', err);
  }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
loadAds();

/********************** ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© **********************/
async function checkImage(url){
  try {
    const res = await fetch(url, { method:'HEAD' });
    return res.ok;
  } catch(e){
    return false;
  }
}

// â€”â€”â€” Ø§Ø³ØªØ¨Ø¯Ù„ buildPopup + loadAds + drawMarkers Ø¨Ø§Ù„Ø´ÙØ±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â€”â€”â€”


// ===================== createFullScreenModal =====================
function createFullScreenModal(ad) {
  const images = Array.isArray(ad.images)
    ? ad.images.map(img => {
        if (!img) return '';
        if (/^https?:\/\//.test(img)) return img;
        return `http://localhost:3000/images/${ad.id}/${encodeURIComponent(img)}`;
      }).filter(Boolean)
    : [];

  const imagesHTML = images.length
    ? `<div class="swiper full-slider" style="width:100%;height:240px;border-radius:10px;overflow:hidden;">
         <div class="swiper-wrapper">
           ${images.map(src => `<div class="swiper-slide"><img src="${src}" style="width:100%;height:240px;object-fit:cover;" onerror="this.style.opacity=0.5;"></div>`).join('')}
         </div>
         <div class="swiper-pagination"></div>
         <div class="swiper-button-next"></div>
         <div class="swiper-button-prev"></div>
       </div>`
    : `<div style="height:240px;background:#e0e0e0;display:flex;align-items:center;justify-content:center;color:#888;font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ±</div>`;

  const fieldConfigs = {
    "Ø£Ø±Ø¶": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'],
    "Ø´Ù‚Ø©": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø¯ÙˆØ±','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'],
    "ÙÙŠÙ„Ø§": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ','Ù…Ø³Ø¨Ø­','Ø­Ø¯ÙŠÙ‚Ø©'],
    "Ù…Ø­Ù„": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ','ÙˆØ§Ø¬Ù‡Ø©']
  };

  const keyMap = {
    'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†':'title','Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±':'type','Ø§Ù„Ù…Ø³Ø§Ø­Ø©':'area','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù':'rooms','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª':'bathrooms',
    'Ø§Ù„Ø³Ø¹Ø±':'price','Ø§Ù„Ù‡Ø§ØªÙ':'phone','Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ':'address','Ø§Ù„ÙˆØµÙ':'description',
    'Ø§Ù„Ø¯ÙˆØ±':'floor','Ù…Ø³Ø¨Ø­':'pool','Ø­Ø¯ÙŠÙ‚Ø©':'garden','Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·':'businessType','ÙˆØ§Ø¬Ù‡Ø©':'front'
  };

  const keys = fieldConfigs[ad.type] || ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'];
  const fields = {};
  for(const key of keys){
    fields[key] = ad[keyMap[key]] ?? 'â€”';
  }

  const fieldsHTML = Object.entries(fields)
    .map(([key, value]) => `<div style="margin-bottom:6px;font-size:14px;color:#222;"><b>${key}:</b> ${value}</div>`).join('');

  const buttonsHTML = `
    <div style="display:flex; justify-content:space-around; margin-top:12px;">
      <a href="tel:${ad.phone}" style="flex:1;margin:0 2px;text-align:center;padding:10px;background:#4CAF50;color:white;border-radius:8px;text-decoration:none;font-size:14px;">ğŸ“ Ø§ØªØµØ§Ù„</a>
      <a href="https://wa.me/${ad.phone}" target="_blank" style="flex:1;margin:0 2px;text-align:center;padding:10px;background:#25D366;color:white;border-radius:8px;text-decoration:none;font-size:14px;">ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨</a>
      <a href="https://www.google.com/maps/search/?api=1&query=${ad.lat},${ad.lon}" target="_blank" style="flex:1;margin:0 2px;text-align:center;padding:10px;background:#4285F4;color:white;border-radius:8px;text-decoration:none;font-size:14px;">ğŸ—ºï¸ Ù…ÙˆÙ‚Ø¹</a>
      <button id="share-btn" style="flex:1;margin:0 2px;padding:10px;background:#FF9800;color:white;border:none;border-radius:8px;font-size:14px;cursor:pointer;">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button>
    </div>
  `;

  const modal = document.createElement('div');
  modal.id = 'ad-fullscreen-modal';
  modal.style.cssText = `position:fixed; top:0; left:0; width:100%; height:100%; background:#f8f9fa; z-index:99999; overflow-y:auto; padding:0; box-sizing:border-box; font-family:sans-serif; animation: fadeIn 0.3s ease forwards;`;
  modal.innerHTML = `<div style="position:relative;">${imagesHTML}<button id="close-fullscreen" style="position:absolute; top:10px; left:10px; z-index:10;background:#f44336;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:18px; cursor:pointer;">âœ–</button></div>
                     <div style="padding:12px;">${fieldsHTML}${buttonsHTML}<div id="mini-map" style="width:100%;height:180px;border-radius:10px;margin-top:10px;"></div></div>`;
  document.body.appendChild(modal);

  document.getElementById('close-fullscreen').onclick = () => modal.remove();

  if (images.length) {
    new Swiper(modal.querySelector('.full-slider'), {
      loop: true,
      pagination: { el: modal.querySelector('.swiper-pagination'), clickable: true },
      navigation: { nextEl: modal.querySelector('.swiper-button-next'), prevEl: modal.querySelector('.swiper-button-prev') },
    });
  }

  if (ad.lat && ad.lon) {
    const miniMap = L.map(modal.querySelector('#mini-map'), { center:[ad.lat,ad.lon], zoom:16, dragging:false, scrollWheelZoom:false, doubleClickZoom:false, zoomControl:false, attributionControl:false });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(miniMap);
    L.marker([ad.lat,ad.lon]).addTo(miniMap);
  }

  const shareBtn = modal.querySelector('#share-btn');
  shareBtn.onclick = () => {
    if(navigator.share) navigator.share({title:ad.title||'Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù‚Ø§Ø±', text:`Ø´Ø§Ù‡Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†: ${ad.title||''}`, url:window.location.href}).catch(err=>console.log(err));
    else alert('Ø®Ø§ØµÙŠØ© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù…ØªØµÙØ­Ùƒ');
  };
}

// ===================== Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø¹Ø± =====================
function makePriceIcon(ad) {
  return L.divIcon({
    html: `<div style="
      background:#1e90ff;
      color:#fff;
      padding:2px 6px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      white-space: nowrap;
    ">${ad.price ?? '--'} Ø¯.Ø£</div>`,
    className: '',
    iconSize: [60, 20]
  });
}

// ===================== createPreviewPanel (Responsive) =====================
function createPreviewPanel(ad) {
  const imageSrc = Array.isArray(ad.images) && ad.images.length
    ? /^https?:\/\//.test(ad.images[0]) ? ad.images[0] : `http://localhost:3000/images/${ad.id}/${encodeURIComponent(ad.images[0])}` : '';
  
  const fieldConfigs = {
    "Ø£Ø±Ø¶": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'],
    "Ø´Ù‚Ø©": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø¯ÙˆØ±','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'],
    "ÙÙŠÙ„Ø§": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ','Ù…Ø³Ø¨Ø­','Ø­Ø¯ÙŠÙ‚Ø©'],
    "Ù…Ø­Ù„": ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ','ÙˆØ§Ø¬Ù‡Ø©']
  };
  const keyMap = {
    'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†':'title','Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±':'type','Ø§Ù„Ù…Ø³Ø§Ø­Ø©':'area','Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù':'rooms','Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª':'bathrooms',
    'Ø§Ù„Ø³Ø¹Ø±':'price','Ø§Ù„Ù‡Ø§ØªÙ':'phone','Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ':'address','Ø§Ù„ÙˆØµÙ':'description',
    'Ø§Ù„Ø¯ÙˆØ±':'floor','Ù…Ø³Ø¨Ø­':'pool','Ø­Ø¯ÙŠÙ‚Ø©':'garden','Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·':'businessType','ÙˆØ§Ø¬Ù‡Ø©':'front'
  };
  const keys = fieldConfigs[ad.type] || ['Ø§Ù„Ø¹Ù†ÙˆØ§Ù†','Ø§Ù„Ù…Ø³Ø§Ø­Ø©','Ø§Ù„Ø³Ø¹Ø±','Ø§Ù„Ù‡Ø§ØªÙ'];
  const fields = {};
  for(const key of keys){
    fields[key] = ad[keyMap[key]] ?? 'â€”';
  }
  const fieldPreview = Object.entries(fields).slice(0,2).map(([k,v])=>`${v}`).join(' | ');

  const div = document.createElement('div');
  div.id = 'ad-preview';
  div.style.cssText = `
    position:fixed; bottom:10px; left:50%; transform:translateX(-50%);
    max-width:95%; width:300px; background:#fff; border-radius:10px;
    box-shadow:0 3px 12px rgba(0,0,0,0.25); cursor:pointer;
    display:flex; flex-direction:row; align-items:center; padding:8px; z-index:9999;
    font-family:sans-serif;
  `;
  div.innerHTML = `
    <img src="${imageSrc}" style="width:60px; height:60px; object-fit:cover; border-radius:6px; margin-right:8px;" onerror="this.style.opacity=0.5;">
    <div style="flex:1; display:flex; flex-direction:column; justify-content:center; overflow:hidden;">
      <div style="font-size:14px; font-weight:600; color:#222; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${ad.title||'â€”'}</div>
      <div style="font-size:12px; color:#555; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${fieldPreview}</div>
      <div style="display:flex; gap:4px; margin-top:4px;">
        <a href="tel:${ad.phone}" style="flex:1;text-align:center;padding:6px;background:#4CAF50;color:white;border-radius:6px;text-decoration:none;font-size:12px;">ğŸ“</a>
        <a href="https://wa.me/${ad.phone}" target="_blank" style="flex:1;text-align:center;padding:6px;background:#25D366;color:white;border-radius:6px;text-decoration:none;font-size:12px;">ğŸ’¬</a>
        <button style="flex:1;text-align:center;padding:6px;background:#FF9800;color:white;border:none;border-radius:6px;font-size:12px;cursor:pointer;" onclick="createFullScreenModal(${JSON.stringify(ad)})">ğŸ”</button>
      </div>
    </div>
  `;
  div.onclick = () => createFullScreenModal(ad);
  return div;
}

// ===================== Animations =====================
const style = document.createElement('style');
style.innerHTML = `
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
`;
document.head.appendChild(style);

// ===================== loadAndDrawMarkers =====================
async function loadAndDrawMarkers() {
  let ads = [];
  try {
    const res = await fetch('http://localhost:3000/listings');
    if(!res.ok) throw new Error('HTTP '+res.status);
    ads = await res.json();
  } catch(e){ console.warn('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', e); return; }

  markers = [];
  for(const ad of ads){
    if(!ad.lat||!ad.lon) continue;
    const marker = L.marker([ad.lat,ad.lon], {icon: makePriceIcon(ad)});
    marker.on('click', ()=>{
      const existing = document.getElementById('ad-preview');
      if(existing) existing.remove();
      document.body.appendChild(createPreviewPanel(ad));
    });
    marker.addTo(map);
    markers.push({ad,marker});
  }
}

// ===================== Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨ Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© =====================
map.on('movestart', ()=>{
  const existing = document.getElementById('ad-preview');
  if(existing) existing.remove();
});

// ===================== Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ =====================
loadAndDrawMarkers();

/********************** ÙÙ„ØªØ±Ø© **********************/
const filters = { q:'', tx:'', area:'', pmin:null, pmax:null, type:'', sort:'recent' };

function withinMap(p){
  const b = map.getBounds();
  return b.contains([p.lat, p.lon]);
}

function applyFilters(){
  let list = PROPS.filter(p=>{
    if(filters.q){
      const q = filters.q.trim().toLowerCase();
      const blob = `${p.title} ${p.area} ${p.type}`.toLowerCase();
      if(!blob.includes(q)) return false;
    }
    if(filters.tx && p.tx !== filters.tx) return false;
    if(filters.type && p.type !== filters.type) return false;
    if(filters.area && p.area !== filters.area) return false;
    if(filters.pmin != null && p.price < filters.pmin) return false;
    if(filters.pmax != null && p.price > filters.pmax) return false;
    return true;
  });

  // Ù‚ØµØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù„Ù‰ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
  list = list.filter(withinMap);

  // ØªØ±ØªÙŠØ¨
  if(filters.sort==='low') list.sort((a,b)=> (a.price||0)-(b.price||0));
  else if(filters.sort==='high') list.sort((a,b)=> (b.price||0)-(a.price||0));
  else list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));

  E('#count').textContent = list.length;
  drawMarkers(list);
  renderList(list);
}

function renderList(list){
  const box = E('#list');
  box.innerHTML = list.map(cardHTML).join('');
}

/********************** ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± **********************/
function openModal(title, inner){
  const html = `
    <div class="font-bold mb-2">${title}</div>
    ${inner}
  `;
  E('#modalContent').innerHTML = html;
  E('#modal').classList.remove('hidden');
}
function closeModal(){ E('#modal').classList.add('hidden'); }
E('#closeModal').onclick = closeModal;

// Ù…Ù†Ø·Ù‚Ø©
E('#fArea').onclick = ()=>{
  const options = AREAS.map(a=>`<option ${filters.area===a?'selected':''} value="${a}">${a||'Ø§Ù„ÙƒÙ„'}</option>`).join('');
  openModal('Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø·Ù‚Ø©', `<select id="iArea" class="w-full p-3 border rounded-xl">${options}</select>`);
  E('#applyModal').onclick = ()=>{ filters.area = E('#iArea').value; setPillState(); closeModal(); applyFilters(); };
};

// Ø¨ÙŠØ¹/Ø¥ÙŠØ¬Ø§Ø±/Ø§Ù„ÙƒÙ„
E('#fType').onclick = ()=>{ filters.tx=''; setPillState(); applyFilters(); };
E('#fSale').onclick = ()=>{ filters.tx='sale'; setPillState(); applyFilters(); };
E('#fRent').onclick = ()=>{ filters.tx='rent'; setPillState(); applyFilters(); };

// Ø§Ù„Ø³Ø¹Ø±
E('#fPrice').onclick = ()=>{
  openModal('Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø±', `
    <div class="grid grid-cols-2 gap-2">
      <input id="iMin" type="number" placeholder="Ø£Ø¯Ù†Ù‰" class="p-3 border rounded-xl" value="${filters.pmin??''}">
      <input id="iMax" type="number" placeholder="Ø£Ø¹Ù„Ù‰" class="p-3 border rounded-xl" value="${filters.pmax??''}">
    </div>
  `);
  E('#applyModal').onclick = ()=>{
    const min = E('#iMin').value; const max = E('#iMax').value;
    filters.pmin = min!=='' ? Number(min) : null;
    filters.pmax = max!=='' ? Number(max) : null;
    setPillState(); closeModal(); applyFilters();
  };
};

// Ø§Ù„Ù…Ø²ÙŠØ¯ (Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±)
E('#fMore').onclick = ()=>{
  openModal('Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±', `
    <select id="iType" class="w-full p-3 border rounded-xl">
      <option value="">Ø§Ù„ÙƒÙ„</option>
      <option value="apartment" ${filters.type==='apartment'?'selected':''}>Ø´Ù‚Ø©</option>
      <option value="villa" ${filters.type==='villa'?'selected':''}>ÙÙŠÙ„Ø§</option>
      <option value="land" ${filters.type==='land'?'selected':''}>Ø£Ø±Ø¶</option>
      <option value="shop" ${filters.type==='shop'?'selected':''}>Ù…Ø­Ù„</option>
    </select>
  `);
  E('#applyModal').onclick = ()=>{ filters.type = E('#iType').value; setPillState(); closeModal(); applyFilters(); };
};

// Ø¨Ø­Ø«
E('#btnSearch').onclick = ()=>{ filters.q = E('#q').value; applyFilters(); };
E('#q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ filters.q = E('#q').value; applyFilters(); } });

// basemap
let satOn = false; E('#btnBasemap').onclick = ()=>{ if(satOn){ map.removeLayer(sat); satOn=false; E('#btnBasemap').classList.remove('active'); } else { sat.addTo(map); satOn=true; E('#btnBasemap').classList.add('active'); } };

// Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·
E('#btnBackToCity').onclick = ()=>{ map.setView(AMMAN, 12); };
E('#btnRefresh').onclick = applyFilters;
E('#sort').onchange = (e)=>{ filters.sort = e.target.value; applyFilters(); };

function setPillState(){
  E('#fSale').classList.toggle('active', filters.tx==='sale');
  E('#fRent').classList.toggle('active', filters.tx==='rent');
  E('#fType').classList.toggle('active', filters.tx==='');
  E('#fArea').classList.toggle('active', !!filters.area);
  E('#fPrice').classList.toggle('active', filters.pmin!=null || filters.pmax!=null);
  E('#fMore').classList.toggle('active', !!filters.type);
}

// Ø§ÙØªØ±Ø¶ Ø£Ù† Ù‡Ø°Ù‡ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù JS Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
async function loadAds() {
  try {
    const res = await fetch('http://localhost:3000/listings');
    const ads = await res.json();
    PROPS = ads.map(ad => {
      if(ad.images && ad.images.length){
        ad.images = ad.images.map(imgName => `http://localhost:3000/images/${ad.id}/${imgName}`);
      }
      return ad;
    });
    drawMarkers(PROPS);
  } catch(err) {
    console.error('Ø®Ø·Ø£ Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª:', err);
  }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
loadAds();

E('#btnAdmin').onclick = () => {
  const areaOpts = AREAS.map(a => `<option value="${a}">${a||'â€”'}</option>`).join('');

  const html = `
  <div class="space-y-3">
    <div class="font-extrabold text-slate-800">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</div>

    <input id="ad_id" type="number" class="p-3 border rounded-xl col-span-2" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)">

    <div class="grid grid-cols-2 gap-2">
      <input id="ad_title" class="p-3 border rounded-xl col-span-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
      <select id="ad_type" class="p-3 border rounded-xl">
        <option value="">-- Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø± --</option>
        <option value="apartment">Ø´Ù‚Ø©</option>
        <option value="villa">ÙÙŠÙ„Ø§</option>
        <option value="land">Ø£Ø±Ø¶</option>
        <option value="shop">Ù…Ø­Ù„</option>
      </select>

      <select id="ad_tx" class="p-3 border rounded-xl">
        <option value="sale">Ù„Ù„Ø¨ÙŠØ¹</option>
        <option value="rent">Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±</option>
      </select>

      <select id="ad_area" class="p-3 border rounded-xl col-span-2">${areaOpts}</select>
      <input id="ad_price" type="number" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      <input id="ad_phone" class="p-3 border rounded-xl col-span-2" placeholder="07XXXXXXXX">
      <input type="file" id="ad_images" multiple accept="image/*" class="p-3 border rounded-xl col-span-2">

      <div id="apartmentFields" class="col-span-2 hidden">
        <input id="ad_space" type="number" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Â²">
        <input id="ad_rooms" type="number" class="p-3 border rounded-xl" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù">
        <input id="ad_bath" type="number" class="p-3 border rounded-xl" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª">
        <input id="ad_living" type="number" class="p-3 border rounded-xl" placeholder="ØµØ§Ù„Ø© Ù…Ø¹ÙŠØ´Ø©">
        <input id="ad_floor" type="number" class="p-3 border rounded-xl" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø·ÙˆØ§Ø¨Ù‚">
        <select id="ad_garage" class="p-3 border rounded-xl">
          <option value="">ÙƒØ±Ø§Ø¬ Ø³ÙŠØ§Ø±Ø©</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
        <select id="ad_elevator" class="p-3 border rounded-xl">
          <option value="">Ù…ØµØ¹Ø¯</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
        <select id="ad_kitchen" class="p-3 border rounded-xl">
          <option value="">Ù…Ø·Ø¨Ø®</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
        <select id="ad_balcony" class="p-3 border rounded-xl">
          <option value="">Ø¨Ù„ÙƒÙˆÙ†Ø©</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
      </div>

      <div id="landFields" class="col-span-2 hidden">
        <input id="ad_land_id" type="text" class="p-3 border rounded-xl" placeholder="Ø±Ù‚Ù… Ù‚Ø·Ø¹Ø© Ø§Ù„Ø£Ø±Ø¶">
        <input id="ad_mudiriyah" type="text" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠØ©">
        <input id="ad_village" type="text" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ù‚Ø±ÙŠØ©">
        <input id="ad_hawd" type="text" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ø­ÙˆØ¶">
        <input id="ad_land_space" type="number" class="p-3 border rounded-xl" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ù…Â²">
        <select id="ad_land_organization" class="p-3 border rounded-xl">
          <option value="">Ø§Ù„ØªÙ†Ø¸ÙŠÙ…</option>
          <option value="residential">Ø³ÙƒÙ†ÙŠ</option>
          <option value="commercial">ØªØ¬Ø§Ø±ÙŠ</option>
          <option value="agricultural">Ø²Ø±Ø§Ø¹ÙŠ</option>
          <option value="industrial">ØµÙ†Ø§Ø¹ÙŠ</option>
          <option value="multiuse">Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù…Ø§Ù„</option>
          <option value="outside">Ø®Ø§Ø±Ø¬ Ø§Ù„ØªÙ†Ø¸ÙŠÙ…</option>
        </select>
        <div class="flex gap-2">
          <label><input type="checkbox" class="resOption" value="A">Ø³ÙƒÙ† Ø£</label>
          <label><input type="checkbox" class="resOption" value="B">Ø³ÙƒÙ† Ø¨</label>
          <label><input type="checkbox" class="resOption" value="C">Ø³ÙƒÙ† Ø¬</label>
          <label><input type="checkbox" class="resOption" value="D">Ø³ÙƒÙ† Ø¯</label>
        </div>
        <select id="ad_land_divided" class="p-3 border rounded-xl">
          <option value="">Ù…ÙØ±ÙˆØ²</option>
          <option value="yes">Ù†Ø¹Ù…</option>
          <option value="no">Ù„Ø§</option>
        </select>
        <input id="ad_land_front" type="text" class="p-3 border rounded-xl" placeholder="Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©">
        <input id="ad_streets_count" type="number" class="p-3 border rounded-xl" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø´ÙˆØ§Ø±Ø¹">
        <input id="ad_streets_width" type="text" class="p-3 border rounded-xl" placeholder="Ø¹Ø±Ø¶ Ø§Ù„Ø´ÙˆØ§Ø±Ø¹ (Ù…)">
        <div class="flex gap-2">
          <label><input type="checkbox" class="services" value="water">Ù…ÙŠØ§Ù‡</label>
          <label><input type="checkbox" class="services" value="electricity">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</label>
          <label><input type="checkbox" class="services" value="sewage">ØµØ±Ù ØµØ­ÙŠ</label>
        </div>
      </div>

      <div class="col-span-2 grid grid-cols-3 gap-2">
        <input id="ad_lat" type="number" step="any" class="p-3 border rounded-xl" placeholder="Lat">
        <input id="ad_lon" type="number" step="any" class="p-3 border rounded-xl" placeholder="Lon">
        <button id="pickOnMap" class="p-3 border rounded-xl">Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
      </div>
    </div>

    <button id="applyModal" class="col-span-2 py-2 bg-emerald-600 text-white rounded-xl">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
  </div>`;

  openModal('Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª', html);

  const typeSelect = E('#ad_type');
  const apartmentFields = E('#apartmentFields');
  const landFields = E('#landFields');

  typeSelect.addEventListener('change', () => {
    if(typeSelect.value==='apartment' || typeSelect.value==='villa'){
      apartmentFields.classList.remove('hidden');
      landFields.classList.add('hidden');
    } else if(typeSelect.value==='land'){
      landFields.classList.remove('hidden');
      apartmentFields.classList.add('hidden');
    } else {
      apartmentFields.classList.add('hidden');
      landFields.classList.add('hidden');
    }
  });

  E('#pickOnMap').onclick = () => {
    const overlay = document.createElement('div');
    overlay.style = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;display:flex;flex-direction:column;';
    overlay.innerHTML = `<div style="flex:1;" id="mapPicker"></div>
    <div class="p-2 grid grid-cols-2 gap-2">
      <button id="confirmLocation" class="p-2 bg-emerald-600 text-white rounded-xl">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
      <button id="closePicker" class="p-2 bg-slate-900 text-white rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
    </div>`;
    document.body.appendChild(overlay);

    const pickerMap = L.map('mapPicker').setView(AMMAN, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 }).addTo(pickerMap);
    let marker = null, lat, lon;
    pickerMap.on('click', e => {
      lat = e.latlng.lat.toFixed(6);
      lon = e.latlng.lng.toFixed(6);
      if(marker) pickerMap.removeLayer(marker);
      marker = L.marker([lat, lon]).addTo(pickerMap);
    });

    E('#confirmLocation').onclick = () => {
      if(lat && lon){
        E('#ad_lat').value = lat;
        E('#ad_lon').value = lon;
        document.body.removeChild(overlay);
        alert('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
      } else alert('Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£ÙˆÙ„Ø§Ù‹.');
    };
    E('#closePicker').onclick = () => document.body.removeChild(overlay);
  };

  // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙˆØ­ÙØ¸Ù‡
  E('#applyModal').onclick = async () => {
    const idField = E('#ad_id').value;
    const isEdit = !!idField;
    const newAd = {
      id: isEdit ? Number(idField) : Date.now(),
      title: E('#ad_title').value.trim(),
      type: typeSelect.value,
      tx: E('#ad_tx').value,
      area: E('#ad_area').value,
      price: Number(E('#ad_price').value||0),
      lat: Number(E('#ad_lat').value),
      lon: Number(E('#ad_lon').value),
      phone: E('#ad_phone').value.trim(),
      images: [],
      createdAt: Date.now()
    };

    if(typeSelect.value==='apartment' || typeSelect.value==='villa'){
      newAd.space = Number(E('#ad_space').value||0);
      newAd.rooms = Number(E('#ad_rooms').value||0);
      newAd.bath = Number(E('#ad_bath').value||0);
      newAd.living = Number(E('#ad_living').value||0);
      newAd.floor = Number(E('#ad_floor').value||0);
      newAd.garage = E('#ad_garage').value;
      newAd.elevator = E('#ad_elevator').value;
      newAd.kitchen = E('#ad_kitchen').value;
      newAd.balcony = E('#ad_balcony').value;
    }

    if(typeSelect.value==='land'){
      newAd.land_id = E('#ad_land_id').value;
      newAd.mudiriyah = E('#ad_mudiriyah').value;
      newAd.village = E('#ad_village').value;
      newAd.hawd = E('#ad_hawd').value;
      newAd.space = Number(E('#ad_land_space').value||0);
      newAd.organization = E('#ad_land_organization').value;
      newAd.divided = E('#ad_land_divided').value;
      newAd.front = E('#ad_land_front').value;
      newAd.streets_count = Number(E('#ad_streets_count').value||0);
      newAd.streets_width = E('#ad_streets_width').value;
      newAd.resOptions = Array.from(document.querySelectorAll('.resOption:checked')).map(c=>c.value);
      newAd.services = Array.from(document.querySelectorAll('.services:checked')).map(c=>c.value);
    }

    const files = E('#ad_images').files;
    const formData = new FormData();
    formData.append('ad', JSON.stringify(newAd));
    for(let f of files) formData.append('images', f);

    try {
      const res = await fetch('http://localhost:3000/saveListing', { method:'POST', body: formData });
      const data = await res.json();
      if(data.success){
        alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­');
        loadAds(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠ
      } else alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸');
    } catch(err){ alert('Ø®Ø·Ø£ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±: '+err.message); }
  };
};


/********************** Ø³Ù„ÙˆÙƒ Ø§Ù„Ø´ÙŠØª (Ø³Ø­Ø¨ Ù…Ø¨Ø³Ø·) **********************/
(function(){
  const sheet = E('#sheet');
  let startY = 0; let startAt = 'collapsed';
  const states = ['collapsed','mid','expanded'];
  function setState(s){ sheet.classList.remove('collapsed','mid','expanded'); sheet.classList.add(s); }
  function current(){ return states.find(s=>sheet.classList.contains(s)) || 'collapsed'; }
  setState('collapsed');

  const onStart = (y)=>{ startY = y; startAt = current(); document.body.style.userSelect='none'; };
  const onMove = (y)=>{ /* live drag ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */ };
  const onEnd = (y)=>{
    const dy = y - startY; // Ù…ÙˆØ¬Ø¨: Ø³Ø­Ø¨ Ù„Ù„Ø£Ø³ÙÙ„
    let next = startAt;
    if(dy < -40){ // Ù„Ù„Ø£Ø¹Ù„Ù‰
      next = startAt === 'collapsed' ? 'mid' : 'expanded';
    } else if(dy > 40){ // Ù„Ù„Ø£Ø³ÙÙ„
      next = startAt === 'expanded' ? 'mid' : 'collapsed';
    }
    setState(next); document.body.style.userSelect='';
  };

  sheet.addEventListener('touchstart', e=> onStart(e.touches[0].clientY));
  sheet.addEventListener('touchmove', e=> onMove(e.touches[0].clientY));
  sheet.addEventListener('touchend', e=> onEnd(e.changedTouches[0].clientY));
  sheet.addEventListener('mousedown', e=> onStart(e.clientY));
  window.addEventListener('mousemove', e=>{ if(startY) onMove(e.clientY); });
  window.addEventListener('mouseup', e=>{ if(startY){ onEnd(e.clientY); startY=0; } });
})();

/********************** ØªÙ‡ÙŠØ¦Ø© *************************/
async function init(){
  setPillState();
  const serverList = await tryFetchServerList();
  if(serverList){ PROPS = serverList; }
  drawMarkers(PROPS);
  applyFilters();
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø¹Ø¯ ØªÙˆÙ‚Ù 150ms
let panTimer=null; map.on('moveend', ()=>{ if(panTimer) clearTimeout(panTimer); panTimer=setTimeout(applyFilters, 150); });

init();

</script>
</body>

</html>